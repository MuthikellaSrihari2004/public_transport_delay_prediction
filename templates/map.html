{% extends "base.html" %}

{% block content %}
<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<section class="hero" style="padding-bottom: 2rem;">
    <h1>Live Navigation</h1>
    <p>Real-time multimodal route planning with realistic traffic mapping.</p>
</section>

<div class="dashboard-layout" style="margin-top: 1rem;">
    <!-- Left Interaction Panel -->
    <div class="side-panel">
        <div class="glass-card" style="padding: 1.5rem;">
            <!-- Transport Mode Toggles -->
            <div class="mode-selector"
                style="display: flex; gap: 10px; margin-bottom: 1.5rem; justify-content: center;">
                <button class="mode-btn active" data-mode="Bus" onclick="selectMode('Bus')">
                    <i data-lucide="bus" size="18"></i>
                    <span>Bus</span>
                </button>
                <button class="mode-btn" data-mode="Metro" onclick="selectMode('Metro')">
                    <i data-lucide="train" size="18"></i>
                    <span>Metro</span>
                </button>
                <button class="mode-btn" data-mode="Train" onclick="selectMode('Train')">
                    <i data-lucide="train-front" size="18"></i>
                    <span>MMTS</span>
                </button>
            </div>

            <div class="form-grid" style="grid-template-columns: 1fr; gap: 1rem;">
                <div class="input-group">
                    <label class="input-label">Origin</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="map-origin" class="input-field">
                            <option value="">Select Origin</option>
                            {% for loc in locations %}
                            <option value="{{ loc }}">{{ loc }}</option>
                            {% endfor %}
                        </select>
                        <button id="gps-btn" class="btn-icon" title="Use My Location" onclick="useMyLocation()">
                            <i data-lucide="crosshair" size="18"></i>
                        </button>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">Destination</label>
                    <select id="map-dest" class="input-field">
                        <option value="">Select Destination</option>
                        {% for loc in locations %}
                        <option value="{{ loc }}">{{ loc }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button id="visualize-btn" class="btn-primary">
                    <i data-lucide="navigation-2" style="margin-right: 8px;"></i> Start Navigation
                </button>
            </div>
        </div>

        <div id="route-stats" class="glass-card"
            style="display: none; margin-top: 1.5rem; animation: slideUp 0.3s ease-out;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>Route Analytics</h3>
                <span class="badge active" id="stat-mode-badge">BUS</span>
            </div>

            <div class="status-grid">
                <div class="status-box">
                    <small>DISTANCE</small>
                    <div id="stat-dist" class="val text-success">-- km</div>
                </div>
                <div class="status-box">
                    <small>DURATION</small>
                    <div id="stat-time" class="val text-warning">-- min</div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; border-top: 1px solid var(--glass-border); padding-top: 1rem;">
                <h4
                    style="font-size: 0.8rem; margin-bottom: 1rem; color: var(--text-muted); text-transform: uppercase;">
                    Turn-by-Turn Stations</h4>
                <div id="stops-list" class="timeline-simple">
                </div>
            </div>
        </div>
    </div>

    <!-- Right Map Visualization -->
    <div class="glass-card"
        style="padding: 0; overflow: hidden; height: 700px; position: relative; border-radius: 20px; border: 1px solid var(--glass-border);">
        <!-- Leaflet Map Container -->
        <div id="map" style="width: 100%; height: 100%; background: #e5e7eb;"></div>

        <!-- Loading Overlay -->
        <div id="map-loading"
            style="display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
            <div style="text-align: center; color: white;">
                <i data-lucide="loader-2" class="pulse" size="48"></i>
                <p style="margin-top: 10px; font-weight: bold;">Calculating optimal path...</p>
            </div>
        </div>
    </div>
</div>

<style>
    /* Mode Selectors */
    .mode-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        color: var(--text-dim);
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.3s;
        flex: 1;
        justify-content: center;
    }

    .mode-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    .mode-btn.active {
        background: var(--accent);
        color: #000;
        border-color: var(--accent);
        font-weight: 700;
        box-shadow: 0 0 15px var(--accent-glow);
    }

    .btn-icon {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        color: var(--accent);
        width: 48px;
        border-radius: 12px;
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: 0.3s;
    }

    .btn-icon:hover {
        background: rgba(56, 189, 248, 0.1);
        transform: scale(1.05);
    }

    /* Timeline */
    .timeline-simple {
        border-left: 2px solid var(--glass-border);
        margin-left: 10px;
        padding-left: 20px;
    }

    .stop-item {
        margin-bottom: 15px;
        position: relative;
        font-size: 0.9rem;
    }

    .stop-item::before {
        content: '';
        position: absolute;
        left: -25px;
        top: 6px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--glass-border);
        border: 2px solid #0f172a;
    }

    .stop-item:first-child::before,
    .stop-item:last-child::before {
        background: var(--accent);
        box-shadow: 0 0 10px var(--accent);
    }

    .stop-item .time {
        font-size: 0.75rem;
        color: var(--text-muted);
        display: block;
        margin-top: 2px;
    }

    /* Custom Map Markers & Popups */
    .duration-label {
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 8px;
        font-weight: bold;
        font-size: 14px;
        color: #333;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        white-space: nowrap;
    }

    .alt-route-label {
        background: #f0f0f0;
        color: #666;
        border: 1px solid #ddd;
    }
</style>

<script>
    let map = null;
    let currentMode = 'Bus';
    let routeLayer = null;
    let markersLayer = null;

    // Coordinate Database (Approximate for Hyderabad)
    const locCoords = {
        "Secunderabad": [17.4399, 78.4983],
        "Koti": [17.3850, 78.4867],
        "L.B. Nagar": [17.3457, 78.5522],
        "Hitech City": [17.4435, 78.3772],
        "Miyapur": [17.4968, 78.3615],
        "Charminar": [17.3616, 78.4747],
        "Gachibowli": [17.4401, 78.3489],
        "Ameerpet": [17.4375, 78.4483],
        "Kukatpally": [17.4849, 78.4138],
        "Uppal": [17.3984, 78.5583],
        "Jubilee Hills": [17.4311, 78.4112],
        "Banjara Hills": [17.4138, 78.4397],
        "Mehdipatnam": [17.3956, 78.4382],
        "Dilsukhnagar": [17.3688, 78.5247],
        "Begumpet": [17.4447, 78.4664],
        "Hyderabad": [17.3850, 78.4867]
    };

    function initMap() {
        // Initialize Leaflet Map
        map = L.map('map').setView([17.3850, 78.4867], 12);

        // Use OpenStreetMap Tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        routeLayer = L.layerGroup().addTo(map);
        markersLayer = L.layerGroup().addTo(map);
    }

    function selectMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.mode-btn[data-mode="${mode}"]`).classList.add('active');
    }

    function useMyLocation() {
        const btn = document.getElementById('gps-btn');
        btn.innerHTML = '<i data-lucide="loader-2" class="pulse"></i>';
        if (window.lucide) lucide.createIcons();

        setTimeout(() => {
            document.getElementById('map-origin').value = "Secunderabad";
            btn.innerHTML = '<i data-lucide="crosshair"></i>';
            if (window.lucide) lucide.createIcons();
            alert("GPS Signal Locked: Secunderabad (Simulated)");
        }, 1200);
    }

    document.addEventListener('DOMContentLoaded', function () {
        if (window.lucide) window.lucide.createIcons();
        initMap();

        document.getElementById('visualize-btn').addEventListener('click', async () => {
            const from = document.getElementById('map-origin').value;
            const to = document.getElementById('map-dest').value;

            if (!from || !to) {
                alert('Please select both start and end locations.');
                return;
            }

            // Show Loading
            document.getElementById('map-loading').style.display = 'flex';
            routeLayer.clearLayers();
            markersLayer.clearLayers();

            try {
                // Fetch Data from Backend
                const res = await fetch('/api/route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ from, to, mode: currentMode })
                });

                if (!res.ok) throw new Error("API Sync Failed");
                const data = await res.json();

                // Process Stats
                document.getElementById('route-stats').style.display = 'block';
                document.getElementById('stat-dist').textContent = (data.distance_km || '12.5') + ' km';
                const speed = currentMode === 'Metro' ? 45 : (currentMode === 'Train' ? 50 : 25);
                const time = Math.round(((data.distance_km || 12.5) / speed) * 60);
                document.getElementById('stat-time').textContent = time + ' min';
                document.getElementById('stat-mode-badge').textContent = currentMode.toUpperCase();

                // Build Timeline
                const stops = (data.stops || '').split('|').filter(s => s.trim());
                const list = document.getElementById('stops-list');
                list.innerHTML = '';
                stops.forEach((s, idx) => {
                    const div = document.createElement('div');
                    div.className = 'stop-item';
                    div.innerHTML = `<strong>${s}</strong><span class="time">+${Math.round((idx + 1) * (time / stops.length))}m</span>`;
                    list.appendChild(div);
                });

                // --- DRAW ROUTE ON MAP ---
                const startCoords = locCoords[from] || locCoords["Secunderabad"];
                const endCoords = locCoords[to] || locCoords["Koti"];

                // Mode color
                let color = '#4285F4'; // Google Blue
                if (currentMode === 'Train') color = '#FBBC04';
                if (currentMode === 'Metro') color = '#EA4335';

                // Markers (Start/End)
                const startIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style='background-color:#10b981; border:3px solid white; border-radius:50%; width:16px; height:16px; box-shadow: 0 0 0 2px #10b981;'></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                const endIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style='background-color:#ef4444; border:3px solid white; border-radius:50%; width:16px; height:16px; box-shadow: 0 0 0 2px #ef4444;'></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                L.marker(startCoords, { icon: startIcon }).addTo(markersLayer).bindPopup("<b>Origin:</b> " + from);
                L.marker(endCoords, { icon: endIcon }).addTo(markersLayer).bindPopup("<b>Destination:</b> " + to).openPopup();

                // 3. FETCH REAL ROAD GEOMETRY (OSRM)
                // We construct a URL with coords: start;stop1;stop2;...;end. 
                let waypoints = [startCoords];

                // Add known intermediate stops
                let rawsStops = (data.stops || '').split('|').filter(s => s.trim());
                let intermediatePoints = [];
                rawsStops.forEach(s => {
                    if (locCoords[s]) intermediatePoints.push(locCoords[s]);
                });

                // Subsample to max 10 to fit OSRM limits
                if (intermediatePoints.length > 0) {
                    const step = Math.ceil(intermediatePoints.length / 10);
                    for (let i = 0; i < intermediatePoints.length; i += step) {
                        waypoints.push(intermediatePoints[i]);
                    }
                }
                waypoints.push(endCoords);

                // Add intermediate markers
                intermediatePoints.forEach(coord => {
                    const stopIcon = L.divIcon({
                        className: 'stop-icon-mini',
                        html: `<div style='background-color:#fff; border:2px solid #666; border-radius:50%; width:8px; height:8px;'></div>`,
                        iconSize: [8, 8],
                        iconAnchor: [4, 4]
                    });
                    L.marker(coord, { icon: stopIcon }).addTo(markersLayer);
                });

                // Build OSRM Query string: lon,lat;lon,lat...
                const coordString = waypoints.map(c => `${c[1]},${c[0]}`).join(';');
                const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${coordString}?overview=full&geometries=geojson`;

                try {
                    const osrmRes = await fetch(osrmUrl);
                    if (!osrmRes.ok) throw new Error("Routing Svc Busy");
                    const osrmData = await osrmRes.json();

                    if (osrmData.routes && osrmData.routes.length > 0) {
                        // Success: Use Real Geometry
                        const routeGeoJSON = osrmData.routes[0].geometry;
                        const latlngs = L.GeoJSON.coordsToLatLngs(routeGeoJSON.coordinates);

                        // Main Line (Thick Blue/Mode Color)
                        L.polyline(latlngs, { color: '#1e3a8a', weight: 10, opacity: 0.3 }).addTo(routeLayer); // Shadow
                        const realPath = L.polyline(latlngs, { color: color, weight: 6, opacity: 1 }).addTo(routeLayer); // Main

                        // Fit Map to Real Path
                        map.fitBounds(realPath.getBounds(), { padding: [50, 50] });

                        // Add Duration Label at center
                        const midPt = latlngs[Math.floor(latlngs.length / 2)];
                        const midIcon = L.divIcon({
                            className: 'duration-label-icon',
                            html: `<div class='duration-label' style="border-left: 5px solid ${color}">
                                    <div style="font-size:1.1em; font-weight:900;">${time} min</div>
                                    <div style="color:#666; font-size:0.85em;">${currentMode} â€¢ ${data.distance_km} km</div>
                                   </div>`,
                            iconSize: [140, 45],
                            iconAnchor: [70, 22]
                        });
                        L.marker(midPt, { icon: midIcon, zIndexOffset: 1000 }).addTo(routeLayer);

                    } else {
                        throw new Error("No OSRM Route");
                    }

                } catch (err) {
                    console.warn("OSRM Failed, falling back to simple line", err);
                    // Fallback: Straight lines between waypoints
                    L.polyline(waypoints, { color: color, weight: 6, opacity: 1, dashArray: '10, 10' }).addTo(routeLayer);
                    map.fitBounds(L.latLngBounds(waypoints), { padding: [50, 50] });
                }



            } catch (e) {
                console.error(e);
                alert("Navigation Sync Error");
            } finally {
                document.getElementById('map-loading').style.display = 'none';
            }
        });
    });
</script>
{% endblock %}